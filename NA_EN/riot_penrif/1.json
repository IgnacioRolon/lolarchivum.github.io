{"poster":"Riot Penrif","date":"2016-10-02T01:11:37.574+0000","title":"Aurelion Sol during Day 1 Worlds","subforum":"Dev Corner","up_votes":1,"down_votes":0,"body":"During Worlds Group Stage Day 1: TSM vs RNG, there was an issue that prevented TSM Bjergsen from seeing the missiles orbiting RNG Xiaohu&#039;s Aurelion Sol.\n\nhttp://i.giphy.com/qoCUOLcLOXcoo.gif\n\nIn this post I will explain the technical details of why this happened.  It&#039;s a complex issue, so stick with me - I&#039;ll walk you through the necessary foundations then follow the cause of the problem and what we&#039;re doing to resolve it.\n\n#Background Technical Information\nAurelion Sol&#039;s missiles have him as their target object.  Usually a missile&#039;s target is the object it homes in on, but in the case of orbiting missiles we utilize the target information to convey which unit the missile orbits around.\n\nWhen the client is told about a missile that&#039;s targeting a unit out of vision, it creates a placeholder object to indicate that the client doesn&#039;t have proper information about that target.  This placeholder prevents the game from utilizing outdated information from a known but not visible unit.\n\nWhen one of Aurelion Sol&#039;s missiles can be seen but he himself cannot, we have a mechanism whereby the server sends positional information of Aurelion to clients so that the missile can be simulated in a reasonably correct position.  I&#039;ll call this process &quot;secondary synchronization.&quot;  We had some issues with the missile showing up in the wrong place sometimes, which were fixed by having the missile stay hidden until correct positional information arrives.  This can happen either through secondary synchronization or by Aurelion becoming visible.\n\nThe final bit of background that you need is that esports spectator clients are not set up like the spectate feature players use.  When you spectate a game you&#039;re not connecting to the game server directly; you&#039;re connecting to a service that takes data from the game server and is able to broadcast it to a wide audience and introduce a delay.  Neither of these properties are ideal for the esports broadcast, so those spectators use a specially created mechanism that allows them to connect directly to the game server.\n\nWith the background covered, let&#039;s dive directly to the root cause and work our way up.\n\n#Root Cause\nThe logic for deciding whether or not the secondary synchronization system should be turned on considers the visibility status of the first 12 clients.  They are sorted by account ID value, regardless of if they represent a player or esports spectator.  12 is the maximum number of players in any kind of League of Legends game, so it&#039;s a reasonable amount for the secondary synchronization logic to check.\n\n#Sequence Leading to Symptom\nIn the setup we were using on day 1, all of the spectator accounts were older than the players&rsquo; accounts.  This led to them having lower account ID values, putting them ahead of the players in the client list.  As I explained above, the logic for secondary synchronization looks at the visibility state of the first 12 clients.  We use more than 12 spectators, so in this state it only considered spectators - and spectators see everything.  So, even in a situation where secondary sync should be enabled, it would decide to keep itself disabled forever.\n\nWithout the secondary sync system functional, Aurelion&#039;s missiles won&#039;t appear to follow his motion once he enters fog of war.  You can see this happen at the end of this clip:\n\nhttp://i.giphy.com/tMrCr1qJKq0PS.gif\n\nThat&rsquo;s already troublesome, as the player gets misleading information.  It gets worse; the client relies on the secondary synchronization system to resolve the target placeholder put in due to the original lack of vision.  This puts the missile in a state where it will never have the correct target.  Since the missile will only show itself once it either gets information through secondary sync or through its target becoming visible, the missile is now forever hidden as both of those triggers have been made impossible.\n\n#Workaround\nProper fixes for this symptom are easy to identify now that we understand what happened step by step.  However, since deploying a new build for an ongoing event is a significant risk on its own, we have decided to work around the issue instead.  By using spectator client accounts that are newer than the players&#039; accounts, we&#039;re able to consistently and completely bypass the root cause.  Our tests have shown this workaround to be reliable.\n\nWe will be implementing the proper fixes as a part of our normal release cycle so that future events will not need to utilize this workaround.\n\nRegards,\n~Riot Penrif","replies":[{"poster":"KittyGotWet","date":"2016-10-02T01:40:22.348+0000","up_votes":6,"down_votes":0,"body":"Interesting to see how the age of the accounts played a factor in this bug. Could we hear more about the process of finding the causes for the bug? I imagine you guys would have been running all sorts of tests before figuring out what it was.","replies":[{"poster":"Riot Penrif","date":"2016-10-02T01:50:40.509+0000","up_votes":22,"down_votes":1,"body":"Oh yes it was quite the voyage of discovery.  We had QA-folk trying anything to reproduce it, attacking from any conceivable angle, engineers staring at code trying to make any sense of the evidence and many other Rioters offering any help they could.  We were finally able to reproduce it on a development machine late in the night and were eventually able to trace a narrative back to root cause early the next day.\n\nTeamwork makes the dream work.","replies":[{"poster":"NottBrandon","date":"2016-10-02T15:04:55.576+0000","up_votes":3,"down_votes":0,"body":"> [{quoted}](name=Riot Penrif,realm=NA,application-id=A7LBtoKc,discussion-id=7KgXRu3X,comment-id=00020000,timestamp=2016-10-02T01:50:40.509+0000)\n>\n> Oh yes it was quite the voyage of discovery.  We had QA-folk trying anything to reproduce it, attacking from any conceivable angle, engineers staring at code trying to make any sense of the evidence and many other Rioters offering any help they could.  We were finally able to reproduce it on a development machine late in the night and were eventually able to trace a narrative back to root cause early the next day.\n> \n> Teamwork makes the dream work.\n\nSo was this only reproducible when all of the first 12 clients for secondary synch were NOT one of the 5 members on the enemy team (the 5 players that don't have vision of ASol)?","replies":[{"poster":"Riot Penrif","date":"2016-10-02T17:32:01.190+0000","up_votes":5,"down_votes":0,"body":"That is correct","replies":[]}]},{"poster":"Ben R4mZ","date":"2016-10-06T00:59:16.773+0000","up_votes":1,"down_votes":0,"body":"> [{quoted}](name=Riot Penrif,realm=NA,application-id=A7LBtoKc,discussion-id=7KgXRu3X,comment-id=00020000,timestamp=2016-10-02T01:50:40.509+0000)\n>\n> Oh yes it was quite the voyage of discovery.  We had QA-folk trying anything to reproduce it, attacking from any conceivable angle, engineers staring at code trying to make any sense of the evidence and many other Rioters offering any help they could.  We were finally able to reproduce it on a development machine late in the night and were eventually able to trace a narrative back to root cause early the next day.\n> \n> Teamwork makes the dream work.\n\nWhat I wouldn't give.....","replies":[]},{"poster":"TauntyArmordillo","date":"2016-10-02T14:22:22.208+0000","up_votes":1,"down_votes":10,"body":"Why are you guys hard-coding everything in your game?","replies":[{"poster":"Psaltus","date":"2016-10-02T15:39:56.475+0000","up_votes":1,"down_votes":0,"body":"I imagine it's to save on processing power.  Resources are extremely valuable in always-online businesses","replies":[]},{"poster":"Delioth","date":"2016-10-02T18:33:37.666+0000","up_votes":4,"down_votes":0,"body":"Because calculating one more number every tick takes resources. When that number hasn't come up until S6 Worlds, it is a non-issue. Some things need to be hard coded for performance, some need to be hard coded for consistency, and some should be hard coded because it isn't worth it to be dynamic. This one fits in 1 and 3.","replies":[]}]}]}]},{"poster":"Linna Excel","date":"2016-10-02T01:15:19.903+0000","up_votes":5,"down_votes":0,"body":"Didn't this happen before, Aussie's orbs not being seen in a pro match? Correct me if I'm wrong but wasn't that fixed?","replies":[{"poster":"Riot Exgeniar","date":"2016-10-02T08:36:19.291+0000","up_votes":6,"down_votes":0,"body":"No, it was a separate issue, and it was fixed. ","replies":[{"poster":"Flemman","date":"2016-10-02T20:52:09.133+0000","up_votes":6,"down_votes":0,"body":"speaking of that previous issue with something obvserve by a player long after it is irrelevant, are you open to use the same tool for ekko timeclone who show for a short time on his old know possition even if it's more than 4 sec and he just appear on the opposite side of the map\n\nisn't that the same issue of false info than the aurelion star's one?","replies":[{"poster":"DeathBurst","date":"2016-10-03T09:49:08.930+0000","up_votes":2,"down_votes":0,"body":"^This please!","replies":[]}]}]},{"poster":"Kritty","date":"2016-10-02T01:23:55.145+0000","up_votes":6,"down_votes":1,"body":"> [{quoted}](name=Linna Excel,realm=NA,application-id=A7LBtoKc,discussion-id=7KgXRu3X,comment-id=0000,timestamp=2016-10-02T01:15:19.903+0000)\n>\n> Didn&#x27;t this happen before, Aussie&#x27;s orbs not being seen in a pro match? Correct me if I&#x27;m wrong but wasn&#x27;t that fixed?\n\nThe previous issue was his orbs sitting where he last disappeared into FoW until he reappeared. That was fixed, but has apparently shown a new bug (this one), that needed a new fix.","replies":[{"poster":"Linna Excel","date":"2016-10-02T01:30:23.886+0000","up_votes":1,"down_votes":0,"body":"Ah, okay.  Thanks for letting me know.\n\nI wonder if his orbs have any more bugs lurking in them.","replies":[{"poster":"gyyyr","date":"2016-10-16T21:57:48.827+0000","up_votes":1,"down_votes":0,"body":"I'm pretty sure they do\nThey just haven't been found yet.","replies":[]}]}]}]},{"poster":"ExHentai","date":"2016-10-02T01:31:06.954+0000","up_votes":1,"down_votes":0,"body":"So, does this workaround mean he is enabled for tomorrow or later?","replies":[{"poster":"Riot Penrif","date":"2016-10-02T01:34:18.618+0000","up_votes":6,"down_votes":1,"body":"Yes, Aurelion Sol will be available for play on day 4.\n\nhttps://twitter.com/lolesports/status/782113765932175360","replies":[]}]},{"poster":"JustCallMeSPED","date":"2017-03-24T18:51:16.373+0000","up_votes":3,"down_votes":0,"body":"As a software engineer, I was genuinely pleased to be able to read the technical information behind this issue.  Shouldn't be using magic numbers in your code.  ;)","replies":[]},{"poster":"Ruffybad","date":"2016-10-02T16:18:13.930+0000","up_votes":1,"down_votes":0,"body":"Do you use secondary sync to hide Sol's information from players lest they use it to maphack or for what reason? The most straightforward implementaion of his W behaviour I could think of is a unit with skin X that has its position updated before any collision checks and then you run collision on all units registered in the game engine, filtered for \"is enemy\", running a function if there is collision. I would also do visibility on the client side so you do not have to be selective in what info you send to clients, League is not bandwidth capped at all so I do not see the problem with it.","replies":[{"poster":"Delioth","date":"2016-10-02T18:36:11.101+0000","up_votes":3,"down_votes":0,"body":"NO! Don't do visibility client-side. That means you're sending the CLIENT all the data on where everything is- which means it can be hacked.","replies":[{"poster":"Aurelion Solari","date":"2016-10-06T10:14:27.533+0000","up_votes":1,"down_votes":2,"body":"I'm not sure you are getting what he means, it would not be hackable, the server is deciding everything, the only thing the client is doing is displaying what the server is processing. What the client should see is only the result of that, you cannot obtain more information about the game from this, likely even with heavy, and very detectable client side modification. \n\nTLDR; can't hack this server brah","replies":[{"poster":"Delioth","date":"2016-10-20T00:40:36.183+0000","up_votes":3,"down_votes":0,"body":">  I would also do visibility on the client side so you** do not have to be selective in what info you send to clients**\n\nThey're not saying to calculate the visibility on the server and send that down- they're saying to send everything to the client and let the client decide what to show. That can be hacked.","replies":[]}]}]}]},{"poster":"9001Teemos","date":"2016-10-02T01:51:46.374+0000","up_votes":1,"down_votes":0,"body":"Isn't this only an issue with the Ashen Lord skin?","replies":[{"poster":"Riot Penrif","date":"2016-10-02T01:55:52.539+0000","up_votes":4,"down_votes":1,"body":"No, it applies to the champion as a whole.","replies":[]}]},{"poster":"GerAvos","date":"2016-10-05T13:59:02.345+0000","up_votes":2,"down_votes":0,"body":"So now spectators will get false information instead of the players?","replies":[{"poster":"gyyyr","date":"2016-10-16T22:03:54.827+0000","up_votes":1,"down_votes":0,"body":"they would, if they were unable to have vision of everyone at the same time.\nThe spectator gets all the information about the location of the champions, even if they have FOW for only one team. The false information is only produced when the used client doesn't get the information of aurelion sols location(the player of the enemy team)","replies":[]},{"poster":"Aurelion Solari","date":"2016-10-06T10:26:47.780+0000","up_votes":1,"down_votes":0,"body":"Nope! from what I understand, everybody sees all the things!!!!!! ALL THE THINGS!!!!!!! unless they actually shouldn't, like my fail flashes in base","replies":[]}]},{"poster":"Kοri","date":"2016-10-02T10:24:53.938+0000","up_votes":2,"down_votes":0,"body":"gj","replies":[]},{"poster":"Panda Eight Six","date":"2016-10-02T08:08:45.852+0000","up_votes":2,"down_votes":0,"body":"Havent tested this, but it happens on Ahri too, her orbs stay on the spot where she disapears in FoW. it stays there for probably about half a second","replies":[]},{"poster":"Lord Blackout","date":"2016-10-02T03:31:53.030+0000","up_votes":2,"down_votes":0,"body":"To me it sounds as if the issue is the order by for account id's being ascending being the primary sort for ensuring an account is in the top 12 clients. Couldn't a fix for this be an active_player_flag = Y or N based on player/spectator respectively, ensuring players are always included in the 12 clients?","replies":[]},{"poster":"Yaknose","date":"2016-10-02T02:59:32.674+0000","up_votes":3,"down_votes":1,"body":"Congratulations on tracking the bug down, that's a serious maze to have to go through to find the cause.","replies":[]},{"poster":"TeCoolMage","date":"2016-10-02T15:38:55.506+0000","up_votes":3,"down_votes":2,"body":"Spaghetti code 101, today it tastes like dragon balls","replies":[]},{"poster":"Troll Armada","date":"2016-10-27T04:21:39.440+0000","up_votes":1,"down_votes":0,"body":"Interesting.\n\nHow long did it take you to track the root cause down? ...or did you immediately have a theory as to the cause?","replies":[]},{"poster":"TeeTohr","date":"2016-10-03T07:22:20.206+0000","up_votes":1,"down_votes":0,"body":"Will the fix be that instead of selecting the 12th first account for the second synchronization, it will select the ID which are playing (as players, not spectators) in the game ?","replies":[]},{"poster":"Popppyseed","date":"2016-10-02T16:10:23.077+0000","up_votes":1,"down_votes":0,"body":"Does this mean other trail effects( Ekkos ult and deadmans) Sometimes showing up misleadingly will also be fixed?","replies":[{"poster":"Delioth","date":"2016-10-02T18:49:48.906+0000","up_votes":1,"down_votes":0,"body":"Did you read? It only affects when there are >12 clients (players, spectators) and NONE or ALL of the top 12 would be able to see it. It wouldn't have a fix for normal games at all, since there is no way to have more than 12 players (spectators don't count since they're different anyways). Additionally, they didn't push though a fix for it, they found a workaround.","replies":[]}]},{"poster":"Declined","date":"2016-10-02T04:10:48.688+0000","up_votes":1,"down_votes":0,"body":"Can you tell us what happened to the match?\nSeeing as this was an official match what is the procedure to handle this?","replies":[{"poster":"zaire90","date":"2016-10-02T05:14:07.163+0000","up_votes":1,"down_votes":0,"body":"> [{quoted}](name=Declined,realm=EUNE,application-id=A7LBtoKc,discussion-id=7KgXRu3X,comment-id=0008,timestamp=2016-10-02T04:10:48.688+0000)\n>\n> Can you tell us what happened to the match?\n> Seeing as this was an official match what is the procedure to handle this?\n\nthere was a remake and the redid the match","replies":[]}]},{"poster":"TheHurricaneGamr","date":"2016-10-02T02:20:34.831+0000","up_votes":1,"down_votes":0,"body":"PINE SOL BABY!","replies":[]},{"poster":"Aurelion Solari","date":"2016-10-06T10:24:57.058+0000","up_votes":1,"down_votes":1,"body":"Thanks actually pretty funny :P I mean I knew that {{champion:136}}  might have some kinks and hitches, but I would have been face desking the entire time, I'm pretty sad at finding bugs that interesting, and by interesting I mean infuriating and mind-blowingly edge case {{sticker:zombie-brand-mindblown}} you guys are my bug squashing heros <3 bug zapper the dream <3 thanks for the post ༼∩ •́ ヮ •̀ ༽⊃━☆ﾟ. * ･ ｡ﾟ Penrif  . * ･ ｡ﾟ☆━੧༼ •́ ヮ •̀ ༽୨","replies":[]},{"poster":"GeoGamer","date":"2016-10-02T12:04:08.834+0000","up_votes":1,"down_votes":1,"body":"So that means the players and two spectators (total 12) will see everything but any more spectators might still see the bug, right? Which is fine i guess, as long as the players don't see the bug. I am pretty sure there are more than 2 spectators watching the game during broadcast.\n\nGreat workaround guys. Nice job.","replies":[{"poster":"AlienTree","date":"2016-10-02T14:28:11.603+0000","up_votes":1,"down_votes":1,"body":"From the post, I believe he said there are more than 12 spectators in the game even! But the key thing about the bug is that it only becomes relevant when Au Sol enters fog of war, so that the \"secondary sync\" can keep up with his position without directly showing the opposing player where he is. Fortunately, spectators rarely (or even never in some cases?) have fog of war disabled - so they won't need secondary sync in the first place. Bug solved for everybody!","replies":[]}]},{"poster":"CLG Dyrus","date":"2016-10-02T03:15:20.573+0000","up_votes":1,"down_votes":5,"body":".","replies":[]},{"poster":"Realsteel97","date":"2016-10-03T15:26:24.858+0000","up_votes":1,"down_votes":6,"body":"When is urgot is going to can any love? It's been 4 years since urgot has scene some CONSISTENT play in the LCS and in higher elos. NO ONE FEARS URGOT. That's bad branding by you guys. All the riot employee(s) that work on urgot say fear urgot and urgot will rise ex(ManWolfAxeBoss). Look at the lcs right now, all you see are tanks, urgot would fit perfectly and will strike fear in tanks. I've spammed urgot for the passed two seasons top,mid and sometimes adc. Urgot is missing mobility and needs more team play. All i feel like when playing urgot is a support not a tanky marksman. Why don't u put urgot on your needs love right after Yorick pls. I love watching lcs and hyping over my favorite team. I feel urgot would make lcs less boring, especially with all those tanks just soaking up all the damage, someone needs to put a stop to them #URGOD RISE. Make him destroy tanks and create fear in adc's please, i've been playing this game since early season 3 and its coming to a point where i might stop playing. Atleast make this a priority this season, I have 189k points on him right now. If you care for what i said right hear and read it all than you would help him please, also if you want to ask how urgot feels top right now, please feel free to ask, not that you would need or care for it, but whatever. #URGOT IS LOVE #URGOT IS LIFE #HE WILL RISE #URGOT CANNOT BE STOPPED #URGOT>RIOT     PLEASE RESPOND","replies":[]}]}